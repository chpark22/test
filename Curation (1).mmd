%% ==========================================
%% Curation & Analysis Pipeline
%% ==========================================
graph TD

    %% ---- Main Pipeline ----
    subgraph "Curation"

        A[Raw Frame] --> B{Pre-Analysis Filtering};

        %% ---- Quality & Duplicate Checks ----
        subgraph "Quality & Duplicate Checks"
            B --> Q1{Quality check};
            Q1 -- "Blurry / Low Info" --> D[Discard];
            Q1 -- "Clear" --> Q2{Duplicate Check};
            Q2 -- "Near Duplicate" --> D;
            Q2 -- "Unique" --> P[Preprocessed Frame];
        end

        P --> S1[Store in S3 preprocessed/];
        P --> C[Analyze with YOLOv11];

        C --> K{Keyframe selection};

        %% ---- Keyframe Triggers ----
        subgraph "Keyframe triggers"
            T1[Object Count change] --> K;
            T2[Significant motion] --> K;
            T3[Time Threshold exceeded] --> K;
        end

        K -- "Clear" --> KF[Promote as Keyframe];
        K -- "Non" --> K_Discard[Discard];

        %% ---- Final Outputs ----
        subgraph "Final Outputs"
            KF --> S2[Store in S3 keyframes/];
            KF --> S3[Store Clip in S3 clips/];
            KF --> M[Publish Metadata to Redis];
        end
    end

    %% ---- Styling ----
    classDef input fill:#dbeafe,stroke:#60a5fa,color:#0f172a;
    classDef process fill:#cbd5e1,stroke:#475569,color:#0f172a;
    classDef decision fill:#fde68a,stroke:#ca8a04,color:#0f172a;
    classDef output fill:#f1f5f9,stroke:#94a3b8,color:#0f172a;
    classDef discard fill:#fee2e2,stroke:#ef4444,color:#991b1b;
    classDef store fill:#e0f2fe,stroke:#0284c7,color:#0f172a;

    class A input;
    class B decision;
    class Q1,Q2,K decision;
    class P,C,KF process;
    class D,K_Discard discard;
    class S1,S2,S3 store;
    class M output;
